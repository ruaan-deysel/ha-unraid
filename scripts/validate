#!/usr/bin/env bash
# Quick validation script to ensure modernization is complete
# This script checks that all required files and configurations are in place

set -e

cd "$(dirname "$0")/.."

echo "üîç Validating modernization..."
echo ""

# Check for required files
echo "üìÅ Checking files..."
required_files=(
    "pyproject.toml"
    ".pre-commit-config.yaml"
    "scripts/setup"
    "scripts/lint"
    "scripts/test"
    ".devcontainer.json"
    "DEVELOPMENT.md"
)

missing_files=0
for file in "${required_files[@]}"; do
    if [ -f "$file" ]; then
        echo "  ‚úÖ $file"
    else
        echo "  ‚ùå $file (MISSING)"
        missing_files=$((missing_files + 1))
    fi
done

# Check for removed files
echo ""
echo "üóëÔ∏è  Checking removed files..."
if [ -f "requirements.txt" ]; then
    echo "  ‚ö†Ô∏è  requirements.txt should be removed"
else
    echo "  ‚úÖ requirements.txt removed"
fi

# Check pyproject.toml content
echo ""
echo "üìã Checking pyproject.toml..."
if grep -q "uv pip install" pyproject.toml 2>/dev/null; then
    echo "  ‚ùå pyproject.toml should not contain install commands"
elif grep -q '\[project\]' pyproject.toml && grep -q 'dependencies =' pyproject.toml; then
    echo "  ‚úÖ pyproject.toml structure valid"
else
    echo "  ‚ö†Ô∏è  pyproject.toml may have issues"
fi

# Check scripts are executable
echo ""
echo "‚öôÔ∏è  Checking script permissions..."
scripts=(
    "scripts/setup"
    "scripts/lint"
    "scripts/test"
    "scripts/develop"
)

for script in "${scripts[@]}"; do
    if [ -x "$script" ]; then
        echo "  ‚úÖ $script is executable"
    else
        echo "  ‚ö†Ô∏è  $script is not executable (run: chmod +x $script)"
    fi
done

# Summary
echo ""
if [ $missing_files -eq 0 ]; then
    echo "‚úÖ Modernization validation PASSED"
    echo ""
    echo "Next steps:"
    echo "  1. Rebuild devcontainer (will install uv automatically)"
    echo "  2. Run ./scripts/setup inside container"
    echo "  3. Run ./scripts/lint to verify ruff works"
    echo "  4. Run ./scripts/test to verify pytest works"
    exit 0
else
    echo "‚ùå Modernization validation FAILED ($missing_files missing files)"
    exit 1
fi
